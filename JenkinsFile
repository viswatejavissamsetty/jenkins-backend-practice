pipeline {
    agent any

    environment {
        // Define any environment variables needed for your build and deployment process
        NODE_VERSION = '18' // Specify the Node.js version
        NPM_VERSION = '9' // Specify the npm version
        APP_NAME = 'DemoApp' // Specify your NestJS application name
        PI_HOST = 'pi' // Specify the hostname or IP address of your Raspberry Pi
        PI_USERNAME = 'pi' // Specify the username for SSH access to your Raspberry Pi
        PI_PASSWORD = '1998' // Specify the password for SSH access to your Raspberry Pi
    }

    stages {
        stage('Build') {
            steps {
                // Set up Node.js and npm
                sh 'pnpm install'

                // Build your NestJS application
                sh 'pnpm run build'
            }
        }

        stage('Deploy') {
            steps {
                // Copy the built application to the Raspberry Pi
                sh "sshpass -p ${PI_PASSWORD} scp -r dist ${PI_USERNAME}@${PI_HOST}:~/${APP_NAME}"

                // Restart the application on the Raspberry Pi
                sh "sshpass -p ${PI_PASSWORD} ssh ${PI_USERNAME}@${PI_HOST} 'pm2 restart ${APP_NAME}'"
            }
        }
    }
}
